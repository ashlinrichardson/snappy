(window.webpackJsonp=window.webpackJsonp||[]).push([["quick-reload~b59ad437"],{Bcqe:function(e,t,i){var s=i("RNvQ"),o=i("tQYX");e.exports=function(e,t,i){var n=!0,a=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return o(i)&&(n="leading"in i?!!i.leading:n,a="trailing"in i?!!i.trailing:a),s(e,t,{leading:n,maxWait:t,trailing:a})}},UnvT:function(e,t,i){"use strict";i.r(t);var s=i("ERkP"),o=i.n(s),n=i("lZoD"),a=i("1U1M"),r=i("qhEF"),c=i("a0gl"),l=i("LEcB"),d=i("+6Tk"),m=i("Czhu"),u=i("zjfJ"),h=i("L21V"),p=i("u6In"),b=i("hpu0"),v=i("3VMZ"),g=i("A79P"),y=i("gScn");const w=Object(h.g)({newVersion:{id:"quick-reload.new-version-published",description:"Flag title to inform user that a new page version is avilable on reload",defaultMessage:"New version published"},newComment:{id:"quick-reload.new-comment",description:"Flag title to inform user that a new page comment is avilable on reload",defaultMessage:"New comment"},newComments:{id:"quick-reload.new-comments",description:"Flag title to inform user that multiple new page comments are avilable on reload",defaultMessage:"{numComments} new comments"},somebodyCommented:{id:"quick-reload.somebody-commented",description:"Flag description to inform who has added a comment",defaultMessage:"{somebody} commented"},twoPeopleCommented:{id:"quick-reload.two-people-commented",description:"Flag description to inform that two people have added comments",defaultMessage:"{somebody} and {somebodyElse} commented"},atLeastThreePeopleCommented:{id:"quick-reload.at-least-three-people-commented",description:"Flag description to inform that multiple people have added comments",defaultMessage:"{somebody} and {numOthers} others commented"},newCommentsLoading:{id:"quick-reload.new-comments-loading",description:"Flag description to inform that comments for the page are being loaded",defaultMessage:"Loading comments for this page..."},somebodyPublished:{id:"quick-reload.somebody-published",description:"Flag description to inform who has re-published this page",defaultMessage:"{somebody} published a new version of this page"},twoPeoplePublished:{id:"quick-reload.two-people-published",description:"Flag description to inform that two people have re-published this page",defaultMessage:"{somebody} and {somebodyElse} published a new version of this page"},atLeastThreePeoplePublished:{id:"quick-reload.at-least-three-people-published",description:"Flag description to inform that multiple people have re-published this page",defaultMessage:"{somebody} and {numOthers} others published a new version of this page"},newContentLoading:{id:"quick-reload.new-content-loading",description:"Flag description to inform that page is being reloaded",defaultMessage:"Loading new version of this page..."},reload:{id:"quick-reload.reload",description:"Button label for button that causes a page reload",defaultMessage:"Reload"},viewComment:{id:"quick-reload.view-comment",description:"label to prompt user to view the latest comment",defaultMessage:"See the latest comment"},viewFirstComment:{id:"quick-reload.view-first-comment",description:"label to prompt user to view the first comment",defaultMessage:"See their comment"}});class f{constructor(e,t,i){this.intl=e,this.currentAccountId=t,this.showFlag=i,Object(u.a)(this,"numEvents",0),Object(u.a)(this,"uniqueNames",[]),Object(u.a)(this,"resetEvents",()=>{this.numEvents=0,this.uniqueNames=[]})}addEvents(e){let t=!1;if(e.forEach(e=>{e.accountId&&this.currentAccountId&&e.accountId===this.currentAccountId||(this.numEvents++,this.uniqueNames=[e.displayName,...this.uniqueNames.filter(t=>t!==e.displayName)],t=!0)}),t){const t=this.createMessage();e[0].url&&(t.url=e[0].url),this.showFlag(t)}}}class O extends f{createMessage(){const e={title:this.intl.formatMessage(w.newVersion),onClose:this.resetEvents};switch(this.uniqueNames.length){case 1:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.somebodyPublished,{somebody:this.uniqueNames[0]}),type:"single"});case 2:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.twoPeoplePublished,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]}),type:"batch"});default:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.atLeastThreePeoplePublished,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1}),type:"batch"})}}}class C extends f{createMessage(){const e={onClose:this.resetEvents,title:1===this.numEvents?this.intl.formatMessage(w.newComment):this.intl.formatMessage(w.newComments,{numComments:this.numEvents})};switch(this.uniqueNames.length){case 1:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.somebodyCommented,{somebody:this.uniqueNames[0]}),type:"single"});case 2:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.twoPeopleCommented,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]}),type:"batch"});default:return Object(m.a)(Object(m.a)({},e),{},{description:this.intl.formatMessage(w.atLeastThreePeopleCommented,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1}),type:"batch"})}}}class I extends s.Component{constructor(...e){super(...e),Object(u.a)(this,"startPoller",e=>{this.stopPoller=this.props.poller(this.props.intl,this.props.timer,this.props.contentId,this.props.currentAccountId,e,this.makeShowFlag,this.hideFlags)}),Object(u.a)(this,"fireReloadAnalytics",e=>{const{createAnalyticsEvent:t}=this.props;t&&t({type:"sendUIEvent",data:{source:"quickReload",action:"clicked",actionSubject:"button",actionSubjectId:"quickReloadButton",attributes:Object(m.a)({veryQuickReload:!1},e)}}).fire()}),Object(u.a)(this,"resetEvents",e=>{if("POLLING"===this.props.subscriptionCohort)this.stopPoller(!1),this.startPoller(Date.now());else if("SUBSCRIPTIONS"===this.props.subscriptionCohort){(e?this.state.commentStream:this.state.editsStream).resetEvents()}}),Object(u.a)(this,"reload",async(e,t,i,s)=>{const{intl:o,push:n,contentId:a,isNextRendered:r,flagsStateContainer:c}=this.props,l=e?this.showingFlagIdsForType.comment:this.showingFlagIdsForType.edit,d=e?o.formatMessage(w.newCommentsLoading):o.formatMessage(w.newContentLoading);await c.updateFlag(l,{description:d,actions:[]});const m={veryQuickReload:!0,isNextRendered:r,contentId:a,type:e?"comment":"edit"};var u;let h;u=m,Object(b.b)().start({name:v.a.QUICK_RELOAD,timeout:g.a.DEFAULT,attributes:u});try{await t(s)}catch(p){h=p}var p;this.fireReloadAnalytics(m),h?(p=h,Object(b.c)(v.a.QUICK_RELOAD,p),i()):Object(b.b)().succeed({name:v.a.QUICK_RELOAD}),c.hideFlag(l),this.resetEvents(e),s&&n(s,!1)}),Object(u.a)(this,"commentFlagOnClick",async e=>{const{push:t,reloadComments:i}=this.props,s=()=>{e?t(e,!0):window.location.reload()};i?await this.reload(!0,i,s,e):(this.fireReloadAnalytics(),s())}),Object(u.a)(this,"contentFlagOnClick",async()=>{const{reloadContent:e}=this.props,t=()=>{window.location.reload()};e?await this.reload(!1,e,t):(this.fireReloadAnalytics(),t())}),Object(u.a)(this,"stopPoller",()=>{}),Object(u.a)(this,"actions",[{content:o.a.createElement("div",{"data-test-id":"quick-reload-reload-button"},this.props.intl.formatMessage(w.reload)),onClick:this.contentFlagOnClick}]),Object(u.a)(this,"showingFlagIdsForType",{edit:void 0,comment:void 0}),Object(u.a)(this,"makeShowFlag",e=>async t=>{const{createAnalyticsEvent:i}=this.props,s=this.showingFlagIdsForType[e],{url:n,type:a}=t,r=[{content:o.a.createElement("div",{"data-test-id":"quick-reload-reload-button"},"single"===a?this.props.intl.formatMessage(w.viewFirstComment):this.props.intl.formatMessage(w.viewComment)),onClick:()=>this.commentFlagOnClick(n)}],c=await this.props.flagsStateContainer.showInfoFlag(Object(m.a)(Object(m.a)({},t),{},{actions:"comment"===e?r:this.actions,onClose:()=>{delete this.showingFlagIdsForType[e],t.onClose(),i&&i({type:"sendUIEvent",data:{source:"quickReload",action:"closed",actionSubject:"flag",actionSubjectId:"flagCloseButton"}}).fire()}}));void 0===this.showingFlagIdsForType.edit&&void 0===this.showingFlagIdsForType.comment&&i&&i({type:"sendOperationalEvent",data:{source:"quickReload",action:"displayed",actionSubject:"quickReloadFlag"}}).fire(),this.showingFlagIdsForType[e]=c.id,void 0!==s&&await this.props.flagsStateContainer.hideFlag(s)}),Object(u.a)(this,"hideFlags",()=>{["edit","comment"].forEach(async e=>{const t=this.showingFlagIdsForType[e];void 0!==t&&(await this.props.flagsStateContainer.hideFlag(t),delete this.showingFlagIdsForType[t])})})}componentDidMount(){"POLLING"===this.props.subscriptionCohort?this.startPoller(this.props.lastPollTime):"SUBSCRIPTIONS"===this.props.subscriptionCohort&&this.setState((e,t)=>Object(m.a)(Object(m.a)({},e),{},{commentStream:new C(t.intl,t.currentAccountId,this.makeShowFlag("comment")),editsStream:new O(t.intl,t.currentAccountId,this.makeShowFlag("edit"))}))}componentDidUpdate(e){if("POLLING"===this.props.subscriptionCohort)this.props.contentId!==e.contentId&&(this.stopPoller(),this.startPoller(this.props.lastPollTime));else if("SUBSCRIPTIONS"===this.props.subscriptionCohort&&this.state.commentStream&&this.props.subscription!==e.subscription){var t,i;const{quickReloadSubscriptions:e}=this.props.subscription;var s,o,n;if("comment"===(null===(t=e.contentType)||void 0===t?void 0:t.value))this.state.commentStream.addEvents([{displayName:null===(s=e.author)||void 0===s?void 0:s.displayName,url:null===(o=e.quickReloadContent)||void 0===o?void 0:o.links.webui,accountId:null===(n=e.author)||void 0===n?void 0:n.accountId}]);else if("page"===(null===(i=e.contentType)||void 0===i?void 0:i.value)){var a,r;this.state.editsStream.addEvents([{displayName:null===(a=e.author)||void 0===a?void 0:a.displayName,accountId:null===(r=e.author)||void 0===r?void 0:r.accountId}])}}}componentWillUnmount(){"POLLING"===this.props.subscriptionCohort&&this.stopPoller()}render(){return null}}const k=Object(h.h)(Object(p.a)()(Object(y.a)(I)));var F=i("p0L4"),j=i("rc7/"),q=i("F4Ur"),T=i("8TdO"),A=i("H5qd"),N=i.n(A);const R=N.a`query QuickReloadQuery($contentId:ID!$since:ExperimentalLong!)@experimental{experimentalQuickReload(contentId:$contentId since:$since){time editorForPage{displayName accountId}comments{comment{id url author{displayName accountId}}}}}`,E=N.a`subscription QuickReloadSubscription($contentId:ID!){quickReloadSubscriptions(contentId:$contentId){contentId createdAt author{accountId displayName}contentType{value}quickReloadContent{...on CommentDocument{id links{webui}}}}}`,S=N.a`query PageRestrictionsQuery($contentId:ID!){content(id:$contentId){nodes{id hasInheritedRestrictions hasRestrictions hasViewRestrictions}}}`;async function P(e,t,i,s){return async function(e,t,i,s,o){var n,a,r;let c;if(!i||!t)return;try{c=await e({query:R,variables:{contentId:i,since:t},fetchPolicy:"no-cache",errorPolicy:"all",context:{fetchOptions:{ignoreNoNetworkError:!0},single:!0}})}catch(p){return void((Object(j.b)(p)||p instanceof F.a)&&Object(q.a)(p))}if(c.errors&&c.errors.length){var l;const e=null!=(l=c)&&null!=(l=l.data)&&null!=(l=l.experimentalQuickReload)?l.status:l;return void[...c.errors.filter(e=>Object(j.b)(e)),...c.errors.filter(t=>t instanceof F.a||!e)].forEach(e=>Object(q.a)(e))}if(o.stopped)return;if(s!==o.querySeq)return;const d=((null!=(r=c)&&null!=(r=r.data)&&null!=(r=r.experimentalQuickReload)?r.comments:r)||[]).map(e=>{var t,i,s,o;return{id:null!=(o=e)&&null!=(o=o.comment)?o.id:o,displayName:null!=(s=e)&&null!=(s=s.comment)&&null!=(s=s.author)?s.displayName:s,url:null!=(i=e)&&null!=(i=i.comment)?i.url:i,accountId:null!=(t=e)&&null!=(t=t.comment)&&null!=(t=t.author)?t.accountId:t}});d.length&&o.commentsStream.addEvents(d);const m=null!=(a=c)&&null!=(a=a.data)&&null!=(a=a.experimentalQuickReload)?a.editorForPage:a;if(m){var u,h;const e=(null!=(h=m)?h.displayName:h)||"",t=(null!=(u=m)?u.accountId:u)||null;o.editsStream.addEvents([{displayName:e,accountId:t}])}return null!=(n=c)&&null!=(n=n.data)&&null!=(n=n.experimentalQuickReload)?n.time:n}(Object(T.getApolloClient)().query,e,t,i,s)}function L(e,t,i,s,o,n,a){const r={querySeq:0,stopped:!1,editsStream:new O(e,s,n("edit")),commentsStream:new C(e,s,n("comment"))},c=new t(async()=>{const e=await P(o,i,++r.querySeq,r);e&&(o=e)});return c.start(),(e=!0)=>{r.stopped=!0,c.stop(),e&&a()}}var M=i("Bcqe"),x=i.n(M);const D={min:6e4,max:12e4,inactivity:12e4},Q={min:4e3,max:4e3,inactivity:4e3};class U{isDocumentHidden(){return"boolean"==typeof window.__documentHiddenOverrideForUnitTest?window.__documentHiddenOverrideForUnitTest:document.hidden}calculateNextDue(){const e=Date.now()-this.lastActivityAt>=this.options.inactivity?this.options.max:this.options.min;return this.lastCallbackAt+e}setTimerToFireAt(e){void 0!==this.timer&&clearTimeout(this.timer);const t=Date.now(),i=Math.max(0,e-t);this.timer=setTimeout(this.timerDidFire,i),this.nextCallbackAt=t+i}bringTimerForwardTo(e){this.nextCallbackAt>e&&this.setTimerToFireAt(e)}executeCallback(){setTimeout(this.callback,0),this.lastCallbackAt=Date.now()}setTimerFromCold(){this.setTimerToFireAt(this.calculateNextDue())}constructor(e){if(this.callback=e,Object(u.a)(this,"options",void 0),Object(u.a)(this,"timer",void 0),Object(u.a)(this,"lastActivityAt",void 0),Object(u.a)(this,"lastCallbackAt",void 0),Object(u.a)(this,"nextCallbackAt",void 0),Object(u.a)(this,"timerDidFire",()=>{this.timer=void 0,this.executeCallback(),this.setTimerFromCold()}),Object(u.a)(this,"didReceiveActivity",x()(()=>{this.lastActivityAt=Date.now(),this.bringTimerForwardTo(this.calculateNextDue())},500)),Object(u.a)(this,"visibilityDidChange",()=>{this.isDocumentHidden()?(void 0!==this.timer&&clearTimeout(this.timer),this.timer=void 0,this.nextCallbackAt=1/0):(this.lastActivityAt=Date.now(),this.setTimerFromCold())}),this.options=Object(m.a)({},D),window.__fastQuickReloadTimerForIntegrationTest){this.options=Object(m.a)(Object(m.a)({},this.options),Q);const e=document.createElement("div");e.setAttribute("data-test-id","quick-reload-test-marker"),document.body.appendChild(e)}this.lastActivityAt=0,this.lastCallbackAt=0,this.nextCallbackAt=0}start(){window.addEventListener("focus",this.didReceiveActivity),document.addEventListener("visibilitychange",this.visibilityDidChange),document.addEventListener("click",this.didReceiveActivity),document.addEventListener("scroll",this.didReceiveActivity);const e=Date.now();this.lastCallbackAt=e,this.lastActivityAt=e,this.nextCallbackAt=1/0,this.setTimerFromCold()}stop(){window.removeEventListener("focus",this.didReceiveActivity),document.removeEventListener("visibilitychange",this.visibilityDidChange),document.removeEventListener("click",this.didReceiveActivity),document.removeEventListener("scroll",this.didReceiveActivity),clearTimeout(this.timer),this.timer=void 0}}var B=i("1N1n");i.d(t,"QuickReload",(function(){return _}));const _=({contentId:e,lastPollTime:t,timerOverride:i,isNextRendered:m})=>{const{userId:u}=Object(c.a)(),{cohort:h}=Object(l.a)("confluence.frontend.quick.reload.strategy",["POLLING","SUBSCRIPTIONS","BOTH"],"POLLING"),{reloaders:p}=Object(s.useContext)(B.b),b=Object(d.a)(B.a),v=b?p.content:void 0,g=b?p.comment:void 0,{data:y,error:w,loading:f}=Object(a.d)(S,{variables:{contentId:e}}),{data:O}=Object(a.e)(E,{variables:{contentId:e},skip:(()=>{var e;if(w||f)return!0;if("SUBSCRIPTIONS"!==h)return!0;const t=null==y||null===(e=y.content)||void 0===e?void 0:e.nodes[0];return!t||(t.hasInheritedRestrictions||t.hasRestrictions||t.hasViewRestrictions)})()});return w||f?null:o.a.createElement(n.c,{to:[r.a]},s=>o.a.createElement(k,{flagsStateContainer:s,poller:L,subscriptionCohort:h,subscription:O,contentId:e,isNextRendered:m||!1,currentAccountId:u,reloadContent:v,reloadComments:g,lastPollTime:t,timer:i||U}))}}}]);
//# sourceMappingURL=quick-reload~b59ad437.BkQU5o7csB.js.map